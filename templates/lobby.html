<!-- Version: 4.9.0 -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Werewolves Lobby</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: #111;
        color: gainsboro;
        min-height: 100vh;
      }
      .lobby-container {
        width: 90%;
        max-width: 1025px;
        margin: 20px auto;
        padding: 20px;
        background-color: #1e1e1e;
        border: 1px solid #444;
        border-radius: 8px;
        display: grid;
      }
      #player-list {
        padding-left: 0;
      }
      #player-list li {
        margin-bottom: 10px;
        list-style-type: none;
        padding: 8px;
        background-color: #2c2c2c;
        border-radius: 5px;
      }
      .admin-controls {
        margin-top: 20px;
        padding-top: 10px;
        border-top: 1px solid #444;
      }
      .exclude-btn {
        margin-left: 15px;
        color: salmon;
        cursor: pointer;
        font-weight: normal;
      }
      .you {
        font-weight: bold;
      }
      input[type="text"],
      input[type="number"] {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #444;
        background-color: #2c2c2c;
        color: gainsboro;
      }
      button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background-color: mediumblue;
        color: gainsboro;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover:not(:disabled) {
        background-color: royalblue;
      }
      button:disabled {
        background-color: #333;
        color: dimgray;
        cursor: not-allowed;
      }
      .timer-setting {
        margin-bottom: 10px;
      }
      .timer-setting label {
        display: inline-block;
        width: 150px;
      }
      .timer-setting input {
        width: 80px;
      }

      /* --- Role Grid Styles --- */
      #roles-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        padding: 20px;
      }

      /* Individual Role Tile */
      .role-tile {
        position: relative; /* Crucial for positioning the tooltip */
        background-color: #111;
        border: 1px solid darkgray;
        border-radius: 5px;
        width: 220px;
        padding: 6px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.2s,
          background-color 0.2s;
        display: flex;
        flex-direction: column; /* Ensure vertical stacking */
        align-items: center;
        cursor: pointer;
      }
      /* Position the checkbox in the top-left or right */
      .role-tile input[type="checkbox"] {
        appearance: none; /* Remove default system styling */
        -webkit-appearance: none; /* Safari support */
        position: absolute;
        top: 8px;
        right: 8px;
        width: 16px;
        height: 16px;

        border: 2px solid var(--role-color, #777);
        border-radius: 5px;
        cursor: pointer;
        background-color: transparent;
        transition: all 0.2s;
        margin: 0; /* Reset margins */
      }
      .role-tile input[type="checkbox"]:checked {
        background-color: var(--role-color, #777);
        box-shadow: 0 0 5px var(--role-color); /* Optional glow */
      }
      .role-tile input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        left: 4px;
        top: 0px;
        width: 5px;
        height: 10px;
        border: solid black; /* Dark checkmark for contrast on bright colors */
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }
      /* Highlight selected tiles */
      .role-tile.selected {
        border: 1px solid darkviolet;
        background-color: black;
      }
      /* Darken background slightly on selected hover for contrast */
      .role-tile.selected:hover {
        background-color: #1e1e1e;
      }
      .role-tile:hover {
        transform: translateY(-4px); /* Slight lift on hover */
        background-color: #1e1e1e;
        border-color: orangered;
      }
      .role-tile h3 {
        margin-top: 4px;
        margin-bottom: 2px;
        font-size: 1.2em;
        color: gainsboro;
        width: 100%;
        transition: color 0.2s;
      }
      .role-tile:hover h3 {
        color: var(--role-color);
      }
      .role-short-desc {
        font-size: 0.9em;
        font-weight: bold;
        margin-top: 4px;
        margin-bottom: 2px;
        line-height: 1.2;
        color: darkgray;
        /* Color is set via inline JS based on rating */
      }

      /* --- Tooltip Styles --- */
      .role-tooltip {
        visibility: hidden;
        opacity: 0;
        width: 260px;
        background-color: #2c2c2c;
        color: white;
        text-align: left;
        border-radius: 5px;
        padding: 12px;

        /* Position the tooltip above the tile */
        position: absolute;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100; /* Ensure it floats on top of everything */
        transition: opacity 0.2s;
        font-size: 0.85rem;
        line-height: 1.4;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        pointer-events: none; /* Prevents tooltip from blocking mouse events */
      }

      /* The little triangle arrow at the bottom of the tooltip */
      .role-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #2c2c2c transparent transparent transparent;
      }

      /* Show tooltip on hover */
      .role-tile:hover .role-tooltip {
        visibility: visible;
        opacity: 1;
      }
      .tooltip-rating {
        display: block;
        margin-top: 5px;
        padding-top: 5px;
        border-top: 1px solid #444;
        text-align: right;
      }

      /* --- Chat Styles --- */
      .chat-container {
        margin-top: 20px;
        border-top: 1px solid #444;
        padding-top: 15px;
      }
      .chat-messages {
        height: 150px;
        overflow-y: auto;
        border: 1px solid #444;
        border-radius: 5px;
        padding: 10px;
        background: #111;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column-reverse;
      }
      .chat-messages div {
        padding-bottom: 5px;
        margin-bottom: 5px;
        border-bottom: 1px solid #444;
      }
      .chat-messages .announcement {
        color: darkviolet;
      }
      #chat-form {
        display: flex;
      }
      #chat-input {
        flex-grow: 1;
        margin-right: 10px;
      }
      .timer-options {
        display: block;
      }
      .settings-row {
        display: flex;
        flex-wrap: wrap; /* Wraps to next line on small screens */
        gap: 15px;
        margin-bottom: 20px;
      }

      .settings-group {
        flex: 1; /* Both take equal width */
        min-width: 300px; /* Forces stacking if screen is too narrow */
        background-color: #2c2c2c; /* Matches your list background */
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #444;
      }

      .settings-group h4 {
        margin-top: 0;
        border-bottom: 1px solid #444;
        padding-bottom: 8px;
        margin-bottom: 15px;
        color: darkviolet; /* Consistent accent color */
      }

      .settings-group label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        cursor: pointer;
      }

      /* Specific adjustment for the timer inputs to look cleaner */
      .timer-input-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .rating-legend-wrapper {
        position: relative;
        display: inline-block;
        cursor: help;
        font-size: 0.9em;
        font-weight: normal;
        color: gainsboro;
      }

      .legend-tooltip {
        visibility: hidden;
        opacity: 0;
        width: 220px;
        background-color: #2c2c2c;
        color: white;
        text-align: left;
        border-radius: 5px;
        padding: 10px;
        border: 1px solid #444;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);

        /* Position tooltips */
        position: absolute;
        z-index: 1000;
        bottom: 125%; /* Show above the text */
        left: 50%;
        transform: translateX(-50%);

        transition: opacity 0.2s;
        pointer-events: none;
      }

      .legend-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #2c2c2c transparent transparent transparent;
      }

      .rating-legend-wrapper:hover .legend-tooltip {
        visibility: visible;
        opacity: 1;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-top: 4px;
        font-size: 0.85em;
      }

      .legend-item .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        display: inline-block;
      }
      @media (max-width: 768px) {
        .lobby-container {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 480px) {
        .lobby-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
  </head>
  <body>
    <div class="lobby-container">
      <h2>Lobby - Waiting for Players</h2>
      <p id="game-code-area" style="display: none; margin: 0">
        Game Code: <strong id="game-code-display"></strong>
      </p>
      <h3>
        Players:
        <button
          id="add-player-btn"
          style="
            display: none;
            font-size: 0.8em;
            padding: 10px 10px;
            margin-left: 10px;
            color: white;
            background-color: seagreen;
          "
        >
          Add Player
        </button>
      </h3>
      <ul id="player-list"></ul>
      <div
        id="role-summary-container"
        style="
          background: #2c2c2c;
          padding: 10px;
          margin: 10px 0;
          border: 1px solid #444:
          border-radius: 5px;
          color: gainsboro;
        "
      >
        <strong style="color: darkviolet">ROLE COUNT:</strong>
        <span id="role-summary-text">Waiting for players...</span>
      </div>
      <div class="chat-container">
        <h4>Lobby Chat</h4>
        <div id="chat-messages" class="chat-messages"></div>
        <form id="chat-form" action="#">
          <input
            id="chat-input"
            type="text"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button id="chat-send-btn" type="submit">Send</button>
        </form>
      </div>

      <div id="admin-panel" style="display: none">
        <hr />
        <h3>Admin Controls</h3>
        <div style="margin-bottom: 20px">
          <button id="start-game-btn" disabled>Start Game</button>
          <p id="min-players-warning">
            <small style="color: firebrick"
              >Need at least 4 players to start.</small
            >
          </p>
        </div>

        <div class="admin-controls">
          <div class="settings-row">
            <div class="settings-group">
              <h4>Game Mode</h4>

              <label>
                <input type="checkbox" id="mode-pass-and-play" />
                <div>
                  <strong>Pass-and-Play Mode</strong><br />
                  <small style="color: darkgray"
                    >Single device mode. Pauses turns.</small
                  >
                </div>
              </label>

              <label>
                <input type="checkbox" id="mode-solo-ends-game" />
                <div>
                  <strong>Solo win ends game</strong><br />
                  <small style="color: darkgray"
                    >Don't wait for team wins.</small
                  >
                </div>
              </label>

              <label>
                <input type="checkbox" id="ghost-mode-checkbox" />
                <div>
                  <strong>Enable Ghost Mode</strong><br />
                  <small style="color: darkgray"
                    >Dead can vote...sometimes.</small
                  >
                </div>
              </label>
            </div>

            <div class="settings-group">
              <h4>Timer Settings (+30sec)</h4>

              <div
                style="
                  margin-bottom: 15px;
                  padding-bottom: 10px;
                  border-bottom: 1px solid #444;
                "
              >
                <label for="disable-timers-checkbox" style="color: gainsboro">
                  <input type="checkbox" id="disable-timers-checkbox" />
                  <strong>Disable Timers</strong>
                </label>
              </div>

              <div id="timer-options" class="timer-options">
                <div class="timer-input-row">
                  <label for="night-timer-input">Night (sec):</label>
                  <input
                    type="number"
                    id="night-timer-input"
                    value="90"
                    min="30"
                    style="width: 70px"
                  />
                </div>
                <div class="timer-input-row">
                  <label for="accusation-timer-input">Accusation (sec):</label>
                  <input
                    type="number"
                    id="accusation-timer-input"
                    value="90"
                    min="30"
                    style="width: 70px"
                  />
                </div>
                <div class="timer-input-row">
                  <label for="lynch-vote-timer-input">Lynch Vote (sec):</label>
                  <input
                    type="number"
                    id="lynch-vote-timer-input"
                    value="60"
                    min="30"
                    style="width: 70px"
                  />
                </div>
              </div>

              <button id="set-timers-btn" style="width: 50%; margin-top: 10px">
                Set Timers
              </button>
            </div>
          </div>
        </div>
        <div class="admin-controls">
          <h4>
            Roles
            <button
              id="random-roles-btn"
              onclick="selectRandomRoles()"
              style="
                width: auto;
                margin-bottom: 5px;
                background-color: darkviolet;
                color: white;
                margin-right: 10px;
              "
            >
              üé≤ Select Random Roles
            </button>

            <span class="rating-legend-wrapper">
              <span class="info-icon">üí° Rating Guide</span>
              <div class="legend-tooltip">
                <strong>Role Balance Rating:</strong>
                <div class="legend-item">
                  <span class="dot" style="background: blue"></span> + Positive:
                  Villager Alligned
                </div>
                <div class="legend-item">
                  <span class="dot" style="background: darkviolet"></span> ~
                  Zero: Neutral / Unknown
                </div>
                <div class="legend-item">
                  <span class="dot" style="background: crimson"></span> -
                  Negative: Werewolf Aligned
                </div>
                <hr style="border-color: #444; margin: 5px 0" />
                <small
                  >"Random" button selects balanced roles with a total value
                  close to 0.</small
                >
              </div>
            </span>
          </h4>
          <div id="roles-grid">
            <p>Loading roles...</p>
          </div>
        </div>

        <div class="admin-controls">
          <label for="new-game-code-input">Set New Game Code:</label>
          <input
            type="text"
            id="new-game-code-input"
            placeholder="New Code"
            style="margin: 8px"
          />
          <button id="set-code-btn">Set Code</button>
          <button id="toggle-chat-btn" style="margin-left: 10px">
            Toggle Admin Chat
          </button>
        </div>
      </div>
    </div>

    <script>
      const PHASE_LOBBY = "Lobby";
      const PHASE_NIGHT = "Night";
      const PHASE_ACCUSATION = "Accusation";
      const PHASE_LYNCH = "Lynch_Vote";
      const PHASE_GAME_OVER = "Game_Over";

      // Role Keys
      const ROLE_ALPHA_WEREWOLF = "Alpha_Werewolf";
      const ROLE_BACKLASH_WEREWOLF = "Backlash_Werewolf";
      const ROLE_BODYGUARD = "Bodyguard";
      const ROLE_CUPID = "Cupid";
      const ROLE_DEMENTED_VILLAGER = "Demented_Villager";
      const ROLE_FOOL = "Fool";
      const ROLE_HONEYPOT = "Honeypot";
      const ROLE_HUNTER = "Hunter";
      const ROLE_LAWYER = "Lawyer";
      const ROLE_MARTYR = "Martyr";
      const ROLE_MAYOR = "Mayor";
      const ROLE_MONSTER = "Monster";
      const ROLE_PROSTITUTE = "Prostitute";
      const ROLE_RANDOM_SEER = "Random_Seer";
      const ROLE_REVEALER = "Revealer";
      const ROLE_SEER = "Seer";
      const ROLE_SERIAL_KILLER = "Serial_Killer";
      const ROLE_SORCERER = "Sorcerer";
      const ROLE_TOUGH_VILLAGER = "Tough_Villager";
      const ROLE_TOUGH_WEREWOLF = "Tough_Werewolf";
      const ROLE_VILLAGER = "Villager";
      const ROLE_WEREWOLF = "Werewolf";
      const ROLE_WILD_CHILD = "Wild_Child";
      const ROLE_WITCH = "Witch";

      // ROLE COUNT Calculation:
      // CONSTANTS (Must match your Python constants)
      const SPECIAL_WEREWOLVES = [
        "Backlash_Werewolf",
        "Tough_Werewolf",
        "Alpha_Werewolf",
      ];

      const socket = io();
      // Ensure backend renders 'player_id' into the template
      let currentPlayerId = "{{ player_id }}";
      let isPlayerAdmin = false;

      // Elements
      const chatMessages = document.getElementById("chat-messages");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatSendBtn = document.getElementById("chat-send-btn");
      const disableTimersCheckbox = document.getElementById(
        "disable-timers-checkbox",
      );
      const timerOptionsDiv = document.getElementById("timer-options");
      const setTimersButton = document.getElementById("set-timers-btn");

      // --- 1. Role Loading ---
      // [ADDED] Global storage for role metadata (populated from server)
      let ROLE_DATA = {};

      // --- 1. Role Loading ---
      async function loadRoles() {
        try {
          const response = await fetch("/get_roles");
          const roles = await response.json();
          const container = document.getElementById("roles-grid"); // Target the grid directly

          container.innerHTML = ""; // Clear "Loading roles..." text

          roles.forEach((role) => {
            // [CHANGED] Populate Global ROLE_DATA from Server Object
            // The server now sends: short, long, rating, color
            const key = role.name_key.replace(/_/g, " ");

            ROLE_DATA[key] = {
              short: role.short,
              long: role.long,
              rating: role.rating,
              color: role.color,
              team: role.team,
            };

            // 2. Create the Tile
            const tile = document.createElement("div");
            tile.className = "role-tile";

            // [CHANGED] Use role object directly (it has the color now)
            tile.style.setProperty("--role-color", role.color || "#ddd");

            // 3. Create Checkbox
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "selected_roles";
            checkbox.value = role.name_key;
            checkbox.classList.add("role-checkbox");

            // Set default checks
            if (serverRoles !== null) {
              // If we already heard from the server (Rematch), use that
              if (serverRoles.includes(role.name_key)) {
                checkbox.checked = true;
                tile.classList.add("selected");
              }
            } else {
              // Fresh Load: Use Defaults
              const defaultRoles = [ROLE_VILLAGER, ROLE_WEREWOLF, ROLE_SEER];
              if (defaultRoles.includes(role.name_key)) {
                checkbox.checked = true;
                tile.classList.add("selected");
              }
            }

            // Add Event Listener for Checkbox Logic
            checkbox.addEventListener("change", (e) => {
              // Toggle visual style
              if (e.target.checked) tile.classList.add("selected");
              else tile.classList.remove("selected");

              // Admin socket update
              if (isPlayerAdmin) {
                const selected = Array.from(
                  document.querySelectorAll(".role-checkbox:checked"),
                ).map((cb) => cb.value);
                socket.emit("admin_update_roles", { roles: selected });
              }
              updateRoleSummary();
            });

            // 4. Build Tile Content
            const title = document.createElement("h3");
            title.innerText = key + ":";

            // Short Desc
            const shortDesc = document.createElement("p");
            shortDesc.className = "role-short-desc";
            shortDesc.innerText = role.short; // [CHANGED] Use server prop

            // Tooltip
            const tooltip = document.createElement("div");
            tooltip.className = "role-tooltip";
            tooltip.innerHTML = `
                ${role.long}
                <span class="tooltip-rating" style="color: ${role.color}">
                    <span style="float: left; font-weight: normal; ">
                        ${role.team.replace(/_/g, " ")}
                    </span>
                    ${role.rating}
                </span>
            `;

            // 5. Assemble
            tile.appendChild(checkbox);
            tile.appendChild(title);
            tile.appendChild(shortDesc);
            tile.appendChild(tooltip);

            // Make the whole tile clickable to toggle checkbox
            tile.addEventListener("click", (e) => {
              // Prevent infinite loop if clicking the checkbox itself
              if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event("change"));
              }
            });

            container.appendChild(tile);
          });

          updateRoleSummary();
        } catch (err) {
          console.error("Failed to load roles", err);
          document.getElementById("roles-grid").innerHTML =
            '<p style="color:crimson">Error loading roles</p>';
        }
      }
      // --- 2. Socket Events ---

      socket.on("connect", () => {
        loadRoles();
      });

      let serverRoles = null;

      // Merged sync logic: Updates checkbox state AND summary
      socket.on("sync_roles", function (data) {
        console.log("Received roles from server:", data.roles);
        serverRoles = data.roles;

        const checkboxes = document.querySelectorAll(".role-checkbox");
        if (checkboxes.length > 0) {
          checkboxes.forEach((cb) => {
            cb.checked = data.roles.includes(cb.value);
            // Find parent tile and update class
            if (cb.checked) cb.closest(".role-tile").classList.add("selected");
            else cb.closest(".role-tile").classList.remove("selected");
          });
          updateRoleSummary();
        }
      });

      // NEW: Restore Lobby Settings (Checkboxes & Timers)
      socket.on("sync_settings", (settings) => {
        if (!settings || Object.keys(settings).length === 0) return;

        console.log("Restoring settings:", settings);

        // 1. Restore Mode Checkboxes
        const isPnP = settings.mode === "pass_and_play";
        document.getElementById("mode-pass-and-play").checked = isPnP;

        // Toggle Add Player Button
        const addPlayerBtn = document.getElementById("add-player-btn");
        if (addPlayerBtn) {
          addPlayerBtn.style.display = isPnP ? "inline-block" : "none";
        }

        // 2. Restore Solo Win (Logic Inverted)
        // If "continues" is TRUE, "ends-game" checkbox must be FALSE
        // If "continues" is FALSE, "ends-game" checkbox must be TRUE
        const soloEndsGameCb = document.getElementById("mode-solo-ends-game");
        if (soloEndsGameCb) {
          if (settings.solo_win_continues === true) {
            soloEndsGameCb.checked = false;
          } else if (settings.solo_win_continues === false) {
            soloEndsGameCb.checked = true;
          }
        }

        // 3. Restore Ghost Mode
        const ghostCb = document.getElementById("ghost-mode-checkbox");
        if (ghostCb) {
          ghostCb.checked = !!settings.ghost_mode;
        }

        // 4. Restore Timers
        if (settings.timers) {
          const t = settings.timers;

          // Checkbox
          const disableBox = document.getElementById("disable-timers-checkbox");
          if (disableBox) {
            disableBox.checked = !!t.timers_disabled;
            // Trigger change event to hide/show options
            disableBox.dispatchEvent(new Event("change"));
          }

          // Inputs
          if (t.night)
            document.getElementById("night-timer-input").value = t.night;
          if (t.accusation)
            document.getElementById("accusation-timer-input").value =
              t.accusation;
          if (t.lynch_vote)
            document.getElementById("lynch-vote-timer-input").value =
              t.lynch_vote;
        }
      });

      // Merged player list update: Handles list, admin check, AND summary update
      socket.on("update_player_list", (data) => {
        const playerList = document.getElementById("player-list");
        const adminPanel = document.getElementById("admin-panel");
        const startGameBtn = document.getElementById("start-game-btn");
        const gameCodeArea = document.getElementById("game-code-area");

        playerList.innerHTML = "";
        const me = data.players.find((p) => p.id === currentPlayerId);

        // Update Admin Status
        if (me && me.is_admin) {
          isPlayerAdmin = true;
          adminPanel.style.display = "block";
          gameCodeArea.style.display = "block";
          document.getElementById("game-code-display").textContent =
            data.game_code;
        } else {
          isPlayerAdmin = false;
          adminPanel.style.display = "none";
          gameCodeArea.style.display = "none";
        }
        data.players.forEach((player) => {
          const li = document.createElement("li");
          li.textContent = player.name;
          if (player.id === currentPlayerId) {
            li.classList.add("you");
            li.textContent += " (You)";
          }
          if (player.is_admin) li.textContent += " üëë";

          if (isPlayerAdmin && player.id !== currentPlayerId) {
            const excludeBtn = document.createElement("span");
            excludeBtn.textContent = "Exclude";
            excludeBtn.className = "exclude-btn";
            excludeBtn.dataset.playerId = player.id;
            li.appendChild(excludeBtn);
          }
          playerList.appendChild(li);
        });

        // Enable start button if enough players
        startGameBtn.disabled = data.players.length < 4;
        const warningEl = document.getElementById("min-players-warning");
        if (warningEl) {
          warningEl.style.display = startGameBtn.disabled ? "block" : "none";
        }
        setChatMode(data.admin_only_chat);

        // Recalculate roles based on new player count
        updateRoleSummary();
      });

      socket.on("game_started", () => {
        window.location.href = "/game";
      });

      socket.on("force_kick", () => {
        alert("You have been dropped from the lobby.");
        window.location.href = "/";
      });

      socket.on("admin_timers_updated", (data) => {
        const timers = data.timers;
        if (timers.night)
          document.getElementById("night-timer-input").value = timers.night;
        if (timers.accusation)
          document.getElementById("accusation-timer-input").value =
            timers.accusation;
        if (timers.lynch_vote)
          document.getElementById("lynch-vote-timer-input").value =
            timers.lynch_vote;
      });

      socket.on("force_relogin", (data) => {
        alert("New code set. Re-login required.");
        window.location.href = "/";
      });

      socket.on("message", (data) => alert(data.text));

      socket.on("error", (data) => alert("Error: " + data.message));

      socket.on("new_message", (data) => {
        if (data.channel === "lobby" || data.channel === "announcement") {
          const messageEl = document.createElement("div");
          messageEl.innerHTML = DOMPurify.sanitize(data.text);
          if (data.channel === "announcement")
            messageEl.classList.add("announcement");
          chatMessages.prepend(messageEl);
        }
      });

      socket.on("chat_mode_update", (data) => {
        setChatMode(data.admin_only);
      });

      // --- 3. UI Event Listeners ---

      document.getElementById("start-game-btn").onclick = () => {
        // A. Get Roles
        const checkboxes = document.querySelectorAll(
          'input[name="selected_roles"]:checked',
        );
        const selectedRoles = Array.from(checkboxes).map((cb) => cb.value);

        // B. Get Mode
        const passAndPlay =
          document.getElementById("mode-pass-and-play").checked;
        const soloEndsGameCheckbox = document.getElementById(
          "mode-solo-ends-game",
        );
        const soloContinues = soloEndsGameCheckbox
          ? !soloEndsGameCheckbox.checked
          : false;

        // Handle Ghost Mode (Safe check in case element is missing)
        const ghostCheckbox = document.getElementById("ghost-mode-checkbox");
        const ghostMode = ghostCheckbox ? ghostCheckbox.checked : false;

        // C. Get Timers
        const timers = {
          timers_disabled: disableTimersCheckbox.checked,
          night: document.getElementById("night-timer-input").value,
          accusation: document.getElementById("accusation-timer-input").value,
          lynch_vote: document.getElementById("lynch-vote-timer-input").value,
        };

        socket.emit("start_game", {
          roles: selectedRoles,
          settings: {
            mode: passAndPlay ? "pass_and_play" : "standard",
            solo_win_continues: soloContinues,
            ghost_mode: ghostMode,
            timers: timers,
          },
        });
      };

      // Add Player Button Logic (Pass-and-Play)
      document.getElementById("add-player-btn").onclick = () => {
        window.location.href = "/?add_player=1";
      };

      // --- Random Roles Logic ---
      function selectRandomRoles() {
        console.log("Random Roles: Button clicked.");

        try {
          // 1. Determine Player Count
          const playerList = document.getElementById("player-list");
          let numPlayers = playerList ? playerList.children.length : 0;

          // Fallback for testing: If 0 or 1 players, pretend there are 5
          if (numPlayers < 4) {
            console.log(
              "Player count low (" +
                numPlayers +
                "), defaulting to 5 for calculation.",
            );
            numPlayers = 4;
          }

          // 2. Get all checkboxes
          const checkboxes = Array.from(
            document.querySelectorAll(".role-checkbox"),
          );
          if (checkboxes.length === 0) {
            alert("Roles are not loaded yet. Please wait.");
            return;
          }

          let bestSet = [];
          let minDiff = Infinity; // Track the closest we get to 0 balance

          // 3. Monte Carlo Simulation: Try 1000 combinations
          const maxAttempts = 1000;

          for (let i = 0; i < maxAttempts; i++) {
            // A. Pick random count (Between 2 and numPlayers)
            const maxPick = Math.min(checkboxes.length, numPlayers);
            const minPick = 2;
            const countToPick =
              Math.floor(Math.random() * (maxPick - minPick + 1)) + minPick;

            // B. Shuffle and Slice
            const shuffled = checkboxes.slice().sort(() => 0.5 - Math.random());
            const currentSet = shuffled.slice(0, countToPick);

            // C. Calculate Rating Sum
            let totalRating = 0;
            currentSet.forEach((cb) => {
              const key = cb.value.replace(/_/g, " ");
              let rating = 0;
              if (typeof ROLE_DATA !== "undefined" && ROLE_DATA[key]) {
                rating = parseFloat(ROLE_DATA[key].rating);
              }
              if (isNaN(rating)) rating = 0;
              totalRating += rating;
            });

            // D. Check Balance (-0.5 to +0.5)
            const diff = Math.abs(totalRating);

            if (diff <= 0.5) {
              bestSet = currentSet;
              minDiff = diff;
              break;
            }

            if (diff < minDiff) {
              minDiff = diff;
              bestSet = currentSet;
            }
          }

          // 4. Apply the Best Selection Found
          if (bestSet.length > 0) {
            // Uncheck ALL first
            checkboxes.forEach((cb) => {
              cb.checked = false;
              if (cb.closest(".role-tile"))
                cb.closest(".role-tile").classList.remove("selected");
            });

            // Check winners
            bestSet.forEach((cb) => {
              cb.checked = true;
              if (cb.closest(".role-tile"))
                cb.closest(".role-tile").classList.add("selected");
            });

            updateRoleSummary();
            if (typeof isPlayerAdmin !== "undefined" && isPlayerAdmin) {
              const rolesPayload = bestSet.map((cb) => cb.value);
              socket.emit("admin_update_roles", { roles: rolesPayload });
            }
            console.log(
              `Roles randomized. Count: ${bestSet.length}. Balance: ${minDiff.toFixed(1)}`,
            );
          } else {
            alert("Could not generate a valid role set.");
          }
        } catch (err) {
          console.error("Error in selectRandomRoles:", err);
          alert("An error occurred generating roles. Check console.");
        }
      }

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
          socket.emit("send_message", { message: message });
          chatInput.value = "";
        }
      });

      const settingsContainer = document.querySelector(".settings-row");

      if (settingsContainer) {
        settingsContainer.addEventListener("change", (e) => {
          const target = e.target;

          // Ignore clicks that aren't inputs
          if (target.tagName !== "INPUT" && target.tagName !== "SELECT") return;

          switch (target.id) {
            case "mode-pass-and-play":
              socket.emit("admin_update_settings", {
                mode: target.checked ? "pass_and_play" : "standard",
              });
              break;

            case "mode-solo-ends-game":
              // Logic: Checked = "Ends Game", so solo_win_continues is FALSE
              socket.emit("admin_update_settings", {
                solo_win_continues: !target.checked,
              });
              break;

            case "ghost-mode-checkbox":
              socket.emit("admin_update_settings", {
                ghost_mode: target.checked,
              });
              break;

            case "disable-timers-checkbox":
              // Toggle UI visibility immediately
              const timerOptionsDiv = document.getElementById("timer-options");
              const setTimersButton = document.getElementById("set-timers-btn");
              if (timerOptionsDiv)
                timerOptionsDiv.style.display = target.checked
                  ? "none"
                  : "block";
              if (setTimersButton)
                setTimersButton.style.display = target.checked
                  ? "none"
                  : "block";

              // Send to server
              socket.emit("admin_set_timers", {
                timers_disabled: target.checked,
              });
              break;
          }
        });
      }

      // Admin Utils
      document.getElementById("set-code-btn").onclick = () => {
        const newCode = document
          .getElementById("new-game-code-input")
          .value.trim()
          .toUpperCase();
        if (newCode) socket.emit("admin_set_new_code", { new_code: newCode });
        else alert("Please enter a new code.");
      };

      document.getElementById("toggle-chat-btn").onclick = () => {
        socket.emit("admin_toggle_chat");
      };

      document.getElementById("set-timers-btn").onclick = () => {
        socket.emit("admin_set_timers", {
          timers_disabled: document.getElementById("disable-timers-checkbox")
            .checked,
          night: document.getElementById("night-timer-input").value,
          accusation: document.getElementById("accusation-timer-input").value,
          lynch_vote: document.getElementById("lynch-vote-timer-input").value,
        });
      };

      // Handle Exclude Click
      document
        .getElementById("player-list")
        .addEventListener("click", function (e) {
          if (e.target && e.target.className === "exclude-btn") {
            excludePlayer(e.target.dataset.playerId);
          }
        });

      // --- 4. Helpers & Utilities ---

      function excludePlayer(playerId) {
        if (confirm("Exclude this player?")) {
          socket.emit("admin_exclude_player", { player_id: playerId });
        }
      }

      function setChatMode(isAdminOnly) {
        if (isAdminOnly && !isPlayerAdmin) {
          chatSendBtn.disabled = true;
          chatInput.placeholder = "Chat is admin-only";
        } else {
          chatSendBtn.disabled = false;
          chatInput.placeholder = "Type a message...";
        }
      }

      function updateRoleSummary() {
        const playerList = document.getElementById("player-list");
        const numPlayers = playerList ? playerList.children.length : 0;
        const summaryElement = document.getElementById("role-summary-text");
        const startGameBtn = document.getElementById("start-game-btn");

        // 1. Basic Check
        if (numPlayers < 1) {
          summaryElement.textContent = "Waiting for players...";
          summaryElement.style.color = "darkgray";
          return;
        }

        // 2. Get Selected Roles
        const checkboxes = document.querySelectorAll(".role-checkbox:checked");
        let selectedSpecials = [];
        checkboxes.forEach((cb) => selectedSpecials.push(cb.value));

        // 3. Calculate Required Wolf Slots
        let totalWolvesAllowed = 0;
        if (numPlayers >= 4 && numPlayers <= 6) totalWolvesAllowed = 1;
        else if (numPlayers >= 7 && numPlayers <= 8) totalWolvesAllowed = 2;
        else if (numPlayers >= 9 && numPlayers <= 11) totalWolvesAllowed = 3;
        else if (numPlayers >= 12 && numPlayers <= 16) totalWolvesAllowed = 4;
        else totalWolvesAllowed = Math.max(1, Math.floor(numPlayers * 0.25));

        // Count selected wolves
        let wolvesInSelection = 0;
        selectedSpecials.forEach((role) => {
          if (SPECIAL_WEREWOLVES.includes(role) || role === ROLE_WEREWOLF) {
            wolvesInSelection++;
          }
        });

        let extraWolvesNeeded = Math.max(
          0,
          totalWolvesAllowed - wolvesInSelection,
        );
        const totalSlotsNeeded = selectedSpecials.length + extraWolvesNeeded;

        // Validation
        if (totalSlotsNeeded > numPlayers) {
          const diff = totalSlotsNeeded - numPlayers;
          summaryElement.innerHTML = `<strong>‚ö†Ô∏è Too many roles selected!</strong> Deselect ${diff} role(s).`;
          summaryElement.style.color = "#ff8880"; // Red Warning
          startGameBtn.disabled = true; // Prevent starting
          return;
        }

        // Build Display List
        startGameBtn.disabled = numPlayers < 4;
        summaryElement.style.color = "#e0e0e0";

        let finalRoleCounts = {};

        // A. Add selections
        selectedSpecials.forEach((role) => {
          finalRoleCounts[role] = (finalRoleCounts[role] || 0) + 1;
        });

        // B. Add mandatory wolves
        if (extraWolvesNeeded > 0) {
          finalRoleCounts[ROLE_WEREWOLF] =
            (finalRoleCounts[ROLE_WEREWOLF] || 0) + extraWolvesNeeded;
        }

        // C. Fill remainder with Villagers
        let currentCount = 0;
        for (let r in finalRoleCounts) currentCount += finalRoleCounts[r];

        let villagersNeeded = Math.max(0, numPlayers - currentCount);
        if (villagersNeeded > 0) {
          finalRoleCounts[ROLE_VILLAGER] =
            (finalRoleCounts[ROLE_VILLAGER] || 0) + villagersNeeded;
        }

        // D. Format Text
        let outputParts = [];
        for (const [role, count] of Object.entries(finalRoleCounts)) {
          let displayRole = role.replace(/_/g, " ");
          if (count > 1) displayRole += "s";
          if (count > 0)
            outputParts.push(
              count === 1 ? displayRole : `${count} ${displayRole}`,
            );
        }
        summaryElement.textContent = outputParts.join(", ");
      }
    </script>
  </body>
</html>
