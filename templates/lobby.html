<!-- Version: 4.6.0 -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Werewolves Lobby</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        min-height: 100vh;
      }
      .lobby-container {
        width: 90%;
        max-width: 800px; /* Increased width for Role Grid */
        margin: 20px auto;
        padding: 20px;
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
      }
      #player-list {
        padding-left: 0;
      }
      #player-list li {
        margin-bottom: 10px;
        list-style-type: none;
        padding: 8px;
        background-color: #2c2c2c;
        border-radius: 4px;
      }
      .admin-controls {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #444;
      }
      .exclude-btn {
        margin-left: 15px;
        color: #ff8a80;
        cursor: pointer;
        font-weight: normal;
      }
      .you {
        font-weight: bold;
      }
      input[type="text"],
      input[type="number"] {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #444;
        background-color: #2c2c2c;
        color: #e0e0e0;
      }
      button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background-color: #3f51b5;
        color: #ffffff;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover:not(:disabled) {
        background-color: #5c6bc0;
      }
      button:disabled {
        background-color: #333;
        color: #777;
        cursor: not-allowed;
      }
      .timer-setting {
        margin-bottom: 10px;
      }
      .timer-setting label {
        display: inline-block;
        width: 150px;
      }
      .timer-setting input {
        width: 80px;
      }
      /* --- New Styles for Phase 3 --- */
      .role-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .role-item {
        padding: 8px;
        background: #2c2c2c;
        border: 1px solid #444;
        border-radius: 4px;
      }
      .role-item label {
        cursor: pointer;
        display: block;
        font-weight: bold;
      }
      .role-item small {
        display: block;
        color: #aaa;
        font-size: 0.8em;
        margin-top: 4px;
      }
      .chat-container {
        margin-top: 20px;
        border-top: 1px solid #444;
        padding-top: 15px;
      }
      .chat-messages {
        height: 150px;
        overflow-y: auto;
        border: 1px solid #333;
        padding: 10px;
        background: #1e1e1e;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column-reverse;
      }
      .chat-messages div {
        padding-bottom: 5px;
        margin-bottom: 5px;
        border-bottom: 1px solid #333;
      }
      .chat-messages .announcement {
        color: #bb86fc;
        font-weight: bold;
      }
      #chat-form {
        display: flex;
      }
      #chat-input {
        flex-grow: 1;
        margin-right: 10px;
      }
      .timer-options {
        display: block;
      }
    </style>
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
  </head>
  <body>
    <div class="lobby-container">
      <h2>Lobby - Waiting for Players</h2>
      <p id="game-code-area" style="display: none">
        Game Code: <strong id="game-code-display"></strong>
      </p>
      <h3>Players:</h3>
      <ul id="player-list"></ul>
      <div
        id="role-summary-container"
        style="
          background: #2c2c2c;
          padding: 10px;
          margin: 10px 0;
          border: 1px solid #444;
          border-radius: 5px;
          color: #e0e0e0;
        "
      >
        <strong style="color: #90caf9">ROLE COUNT:</strong>
        <span id="role-summary-text">Waiting for players...</span>
      </div>
      <div class="chat-container">
        <h4>Lobby Chat</h4>
        <div id="chat-messages" class="chat-messages"></div>
        <form id="chat-form" action="#">
          <input
            id="chat-input"
            type="text"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button id="chat-send-btn" type="submit">Send</button>
        </form>
      </div>

      <div id="admin-panel" style="display: none">
        <hr />
        <h3>Admin Controls</h3>
        <div style="margin-bottom: 20px">
          <button id="start-game-btn" disabled>Start Game</button>
          <p><small>Need at least 4 players to start.</small></p>
        </div>

        <div class="admin-controls">
          <h4>Game Mode</h4>
          <label style="display: flex; align-items: center; gap: 10px">
            <input type="checkbox" id="mode-pass-and-play" />
            <div>
              <strong>Pass-and-Play Mode</strong><br />
              <small style="color: #aaa"
                >Single/Multiple device mode. Pauses between turns.</small
              >
            </div>
          </label>
        </div>

        <div class="admin-controls">
          <h4>Roles</h4>
          <div id="role-container" class="role-grid">
            <p>Loading roles...</p>
          </div>
        </div>

        <div class="admin-controls">
          <h4>Timer Settings ( >30 seconds)</h4>
          <div class="timer-setting">
            <label for="disable-timers-checkbox">Disable Timers</label>
            <input type="checkbox" id="disable-timers-checkbox" />
          </div>
          <div id="timer-options" class="timer-options">
            <div class="timer-setting">
              <label for="night-timer-input">Night (sec):</label>
              <input type="number" id="night-timer-input" value="90" min="30" />
            </div>
            <div class="timer-setting">
              <label for="accusation-timer-input">Accusation (sec):</label>
              <input
                type="number"
                id="accusation-timer-input"
                value="90"
                min="30"
              />
            </div>
            <div class="timer-setting">
              <label for="lynch-vote-timer-input">Lynch Vote (sec):</label>
              <input
                type="number"
                id="lynch-vote-timer-input"
                value="60"
                min="30"
              />
            </div>
          </div>
          <button id="set-timers-btn">Set Timers</button>
        </div>
        <div class="admin-controls">
          <label for="new-game-code">Set New Game Code:</label>
          <input type="text" id="new-game-code-input" placeholder="New Code" />
          <button id="set-code-btn">Set Code</button>
          <button id="toggle-chat-btn" style="margin-left: 10px">
            Toggle Admin Chat
          </button>
        </div>
      </div>
    </div>

    <script>
      const PHASE_LOBBY = "Lobby";
      const PHASE_NIGHT = "Night";
      const PHASE_ACCUSATION = "Accusation";
      const PHASE_LYNCH = "Lynch_Vote";
      const PHASE_GAME_OVER = "Game_Over";

      // Role Keys
      const ROLE_ALPHA_WEREWOLF = "Alpha_Werewolf";
      const ROLE_BACKLASH_WEREWOLF = "Backlash_Werewolf";
      const ROLE_BODYGUARD = "Bodyguard";
      const ROLE_CUPID = "Cupid";
      const ROLE_DEMENTED_VILLAGER = "Demented_Villager";
      const ROLE_FOOL = "Fool";
      const ROLE_HONEYPOT = "Honeypot";
      const ROLE_HUNTER = "Hunter";
      const ROLE_LAWYER = "Lawyer";
      const ROLE_MARTYR = "Martyr";
      const ROLE_MAYOR = "Mayor";
      const ROLE_MONSTER = "Monster";
      const ROLE_PROSTITUTE = "Prostitute";
      const ROLE_RANDOM_SEER = "Random_Seer";
      const ROLE_REVEALER = "Revealer";
      const ROLE_SEER = "Seer";
      const ROLE_SERIAL_KILLER = "Serial_Killer";
      const ROLE_SORCERER = "Sorcerer";
      const ROLE_TOUGH_VILLAGER = "Tough_Villager";
      const ROLE_TOUGH_WEREWOLF = "Tough_Werewolf";
      const ROLE_VILLAGER = "Villager";
      const ROLE_WEREWOLF = "Werewolf";
      const ROLE_WILD_CHILD = "Wild_Child";
      const ROLE_WITCH = "Witch";

      const socket = io();
      // Ensure backend renders 'player_id' into the template
      let currentPlayerId = "{{ player_id }}";
      let isPlayerAdmin = false;

      // Elements
      const chatMessages = document.getElementById("chat-messages");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatSendBtn = document.getElementById("chat-send-btn");
      const disableTimersCheckbox = document.getElementById(
        "disable-timers-checkbox",
      );
      const timerOptionsDiv = document.getElementById("timer-options");
      const setTimersButton = document.getElementById("set-timers-btn");

      const roleContainer = document.getElementById("role-container");

      // --- 1. Phase 3: Role Loading ---
      async function loadRoles() {
        try {
          const response = await fetch("/get_roles");
          const roles = await response.json();
          roleContainer.innerHTML = "";

          roles.forEach((role) => {
            const wrapper = document.createElement("div");
            wrapper.className = "role-item";

            const label = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "selected_roles";
            checkbox.value = role.name_key; // e.g. "role_werewolf"

            checkbox.classList.add("role-checkbox");
            checkbox.addEventListener("change", () => {
              if (isPlayerAdmin) {
                const selected = Array.from(
                  document.querySelectorAll(".role-checkbox:checked"),
                ).map((cb) => cb.value);
                socket.emit("admin_update_roles", { roles: selected });
              }

              updateRoleSummary();
            });

            const defaultRoles = [ROLE_VILLAGER, ROLE_WEREWOLF, ROLE_SEER];
            if (defaultRoles.includes(role.name_key)) {
              checkbox.checked = true;
            }

            const displayName = role.name_key.replace("_", " ").toUpperCase();

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${displayName}`));

            // Description mapping (could be moved to a util function later)
            const desc = document.createElement("small");
            desc.textContent = role.description_key;

            wrapper.appendChild(label);
            wrapper.appendChild(desc);
            roleContainer.appendChild(wrapper);
          });
          updateRoleSummary();
        } catch (err) {
          console.error("Failed to load roles", err);
          roleContainer.innerHTML =
            '<p style="color:red">Error loading roles</p>';
        }
      }

      // --- 2. Phase 3: Start Game Logic (Aggregates Data) ---
      document.getElementById("start-game-btn").onclick = () => {
        // A. Get Roles
        const checkboxes = document.querySelectorAll(
          'input[name="selected_roles"]:checked',
        );
        const selectedRoles = Array.from(checkboxes).map((cb) => cb.value);

        // B. Get Mode
        const passAndPlay =
          document.getElementById("mode-pass-and-play").checked;

        // C. Get Timers
        const timers = {
          timers_disabled: disableTimersCheckbox.checked,
          night: document.getElementById("night-timer-input").value,
          accusation: document.getElementById("accusation-timer-input").value,
          lynch_vote: document.getElementById("lynch-vote-timer-input").value,
        };

        // D. Build Payload
        const payload = {
          roles: selectedRoles,
          settings: {
            mode: passAndPlay ? "pass_and_play" : "standard",
            timers: timers,
          },
        };

        console.log("Starting game with:", payload);
        socket.emit("start_game", payload);
      };

      // --- 3. Original Logic Preserved ---
      function excludePlayer(playerId) {
        if (confirm("Exclude this player?")) {
          socket.emit("admin_exclude_player", { player_id: playerId });
        }
      }

      function setChatMode(isAdminOnly) {
        if (isAdminOnly && !isPlayerAdmin) {
          chatSendBtn.disabled = true;
          chatInput.placeholder = "Chat is admin-only";
        } else {
          chatSendBtn.disabled = false;
          chatInput.placeholder = "Type a message...";
        }
      }

      socket.on("connect", () => {
        console.log(
          "[DEBUG] Connected to Lobby, server with session ID:",
          currentPlayerId,
        );
        // Trigger role load on connect
        loadRoles();
      });

      socket.on("game_started", () => {
        console.log(
          "[DEBUG] 'game_started' event received. Redirecting to /game page.",
        );
        window.location.href = "/game";
      });

      socket.on("sync_roles", function (data) {
        const checkboxes = document.querySelectorAll(".role-checkbox");
        checkboxes.forEach((cb) => {
          // Update the checkbox visual state based on server data
          cb.checked = data.roles.includes(cb.value);
        });
        // Recalculate the text summary
        updateRoleSummary();
      });

      socket.on("update_player_list", (data) => {
        const playerList = document.getElementById("player-list");
        const adminPanel = document.getElementById("admin-panel");
        const startGameBtn = document.getElementById("start-game-btn");
        const gameCodeArea = document.getElementById("game-code-area");

        playerList.innerHTML = "";
        const me = data.players.find((p) => p.id === currentPlayerId);

        // Update Admin Status
        if (me && me.is_admin) {
          isPlayerAdmin = true;
          adminPanel.style.display = "block";
          gameCodeArea.style.display = "block";
          document.getElementById("game-code-display").textContent =
            data.game_code;
        } else {
          isPlayerAdmin = false;
          adminPanel.style.display = "none";
          gameCodeArea.style.display = "none";
        }
        data.players.forEach((player) => {
          const li = document.createElement("li");
          li.textContent = player.name;
          if (player.id === currentPlayerId) {
            li.classList.add("you");
            li.textContent += " (You)";
          }
          if (player.is_admin) li.textContent += " üëë";

          if (isPlayerAdmin && player.id !== currentPlayerId) {
            const excludeBtn = document.createElement("span");
            excludeBtn.textContent = "Exclude";
            excludeBtn.className = "exclude-btn";
            excludeBtn.dataset.playerId = player.id;
            li.appendChild(excludeBtn);
          }
          playerList.appendChild(li);
        });

        // Enable start button if enough players
        startGameBtn.disabled = data.players.length < 4;
        setChatMode(data.admin_only_chat);
      });

      // Events from original file
      socket.on("force_kick", () => {
        alert("You have been dropped from the lobby.");
        window.location.href = "/";
      });

      socket.on("admin_timers_updated", (data) => {
        const timers = data.timers;

        // Update the input fields with the values returned by the server.
        // If the admin entered '25', the server returned '30', which updates here.
        if (timers.night) {
          document.getElementById("night-timer-input").value = timers.night;
        }
        if (timers.accusation) {
          document.getElementById("accusation-timer-input").value =
            timers.accusation;
        }
        if (timers.lynch_vote) {
          document.getElementById("lynch-vote-timer-input").value =
            timers.lynch_vote;
        }
      });

      socket.on("force_relogin", (data) => {
        alert("New code set. Re-login required.");
        window.location.href = "/";
      });
      socket.on("message", (data) => alert(data.text));
      socket.on("error", (data) => {
        alert("Error: " + data.message);
      });

      socket.on("new_message", (data) => {
        if (data.channel === "lobby" || data.channel === "announcement") {
          const messageEl = document.createElement("div");
          messageEl.innerHTML = data.text;
          if (data.channel === "announcement")
            messageEl.classList.add("announcement");
          chatMessages.prepend(messageEl);
        }
      });

      socket.on("chat_mode_update", (data) => {
        setChatMode(data.admin_only);
      });

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
          socket.emit("send_message", { message: message });
          chatInput.value = "";
        }
      });

      disableTimersCheckbox.addEventListener("change", (e) => {
        const isDisabled = e.target.checked;

        timerOptionsDiv.style.display = isDisabled ? "none" : "block";
        setTimersButton.style.display = isDisabled ? "none" : "block";

        // We send the flag to the server right now so it takes effect instantly.
        console.log("Auto-updating timers_disabled:", isDisabled);
        socket.emit("admin_set_timers", {
          timers_disabled: isDisabled,
        });
      });

      // Admin Utils
      document.getElementById("set-code-btn").onclick = () => {
        const newCode = document
          .getElementById("new-game-code-input")
          .value.trim()
          .toUpperCase();
        if (newCode) socket.emit("admin_set_new_code", { new_code: newCode });
        else {
          alert("Please enter a new code.");
        }
      };
      document.getElementById("toggle-chat-btn").onclick = () => {
        socket.emit("admin_toggle_chat");
      };

      document.getElementById("set-timers-btn").onclick = () => {
        const timersPayload = {
          timers_disabled: document.getElementById("disable-timers-checkbox")
            .checked,
          night: document.getElementById("night-timer-input").value,
          accusation: document.getElementById("accusation-timer-input").value,
          lynch_vote: document.getElementById("lynch-vote-timer-input").value,
        };

        // 2. Send to server
        console.log("Setting timers:", timersPayload);
        socket.emit("admin_set_timers", timersPayload);
      };

      // Handle Exclude Click
      document
        .getElementById("player-list")
        .addEventListener("click", function (e) {
          if (e.target && e.target.className === "exclude-btn") {
            excludePlayer(e.target.dataset.playerId);
          }
        });

      // ROLE COUNT Calculation:
      // CONSTANTS (Must match your Python constants)
      const SPECIAL_WEREWOLVES = [
        "Backlash_Werewolf",
        "Tough_Werewolf",
        "Alpha_Werewolf",
      ];

      function updateRoleSummary() {
        const playerList = document.getElementById("player-list");
        const numPlayers = playerList ? playerList.children.length : 0;
        const summaryElement = document.getElementById("role-summary-text");
        const startGameBtn = document.getElementById("start-game-btn");

        // 1. Basic Check
        if (numPlayers < 1) {
          summaryElement.textContent = "Waiting for players...";
          summaryElement.style.color = "#aaa";
          return;
        }

        // 2. Get Selected Roles
        const checkboxes = document.querySelectorAll(".role-checkbox:checked");
        let selectedSpecials = [];
        checkboxes.forEach((cb) => {
          selectedSpecials.push(cb.value);
        });

        // 3. Calculate Required Wolf Slots
        let totalWolvesAllowed = 0;
        if (numPlayers >= 4 && numPlayers <= 6) {
          totalWolvesAllowed = 1;
        } else if (numPlayers >= 7 && numPlayers <= 8) {
          totalWolvesAllowed = 2;
        } else if (numPlayers >= 9 && numPlayers <= 11) {
          totalWolvesAllowed = 3;
        } else if (numPlayers >= 12 && numPlayers <= 16) {
          totalWolvesAllowed = 4;
        } else {
          totalWolvesAllowed = Math.max(1, Math.floor(numPlayers * 0.25));
        }

        // 4. Check how many wolves are already covered by selections
        // (Both Special Wolves and standard "Werewolf" checkbox count towards the requirement)
        let wolvesInSelection = 0;
        selectedSpecials.forEach((role) => {
          if (SPECIAL_WEREWOLVES.includes(role) || role === ROLE_WEREWOLF) {
            wolvesInSelection++;
          }
        });

        // We only add EXTRA wolves if we haven't met the minimum requirement
        let extraWolvesNeeded = Math.max(
          0,
          totalWolvesAllowed - wolvesInSelection,
        );

        // 5. VALIDATION: Check for Over-Subscription
        // Total slots needed = explicitly selected roles + mandatory extra wolves
        const totalSlotsNeeded = selectedSpecials.length + extraWolvesNeeded;

        if (totalSlotsNeeded > numPlayers) {
          const diff = totalSlotsNeeded - numPlayers;
          summaryElement.innerHTML = `<strong>‚ö†Ô∏è Too many roles selected!</strong> Deselect ${diff} role(s).`;
          summaryElement.style.color = "#ff8a80"; // Red Warning
          startGameBtn.disabled = true; // Prevent starting
          return;
        }

        // 6. If Valid: Build the Display List
        startGameBtn.disabled = numPlayers < 4; // Re-enable if player count is valid
        summaryElement.style.color = "#e0e0e0"; // Reset color

        let finalRoleCounts = {};

        // A. Add selections
        selectedSpecials.forEach((role) => {
          finalRoleCounts[role] = (finalRoleCounts[role] || 0) + 1;
        });

        // B. Add mandatory wolves
        if (extraWolvesNeeded > 0) {
          finalRoleCounts[ROLE_WEREWOLF] =
            (finalRoleCounts[ROLE_WEREWOLF] || 0) + extraWolvesNeeded;
        }

        // C. Fill remainder with Villagers
        let currentCount = 0;
        for (let r in finalRoleCounts) currentCount += finalRoleCounts[r];

        let villagersNeeded = Math.max(0, numPlayers - currentCount);
        if (villagersNeeded > 0) {
          finalRoleCounts[ROLE_VILLAGER] =
            (finalRoleCounts[ROLE_VILLAGER] || 0) + villagersNeeded;
        }

        // D. Format Text
        let outputParts = [];
        for (const [role, count] of Object.entries(finalRoleCounts)) {
          let displayRole = role.replace(/_/g, " ");
          if (count > 1) displayRole += "s";
          if (count > 0) {
            outputParts.push(
              count === 1 ? displayRole : `${count} ${displayRole}`,
            );
          }
        }

        summaryElement.textContent = outputParts.join(", ");
      }
      socket.on("update_player_list", function (data) {
        updateRoleSummary();
      });
    </script>
  </body>
</html>
