<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Werewolves - The Game</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        display: flex;
        justify-content: center;
        margin-top: 20px;
        background-color: #121212;
        color: #e0e0e0;
      }
      .game-container {
        width: 90%;
        max-width: 800px;
        display: flex;
        gap: 20px;
      }
      .main-panel {
        flex-grow: 1;
      }
      .side-panel {
        width: 250px;
        border-left: 1px solid #444;
        padding-left: 20px;
      }
      .player-list {
        padding-left: 0;
      }
      .player-list li {
        list-style-type: none;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 5px;
        background-color: #2c2c2c;
      }
      .player-list li.dead {
        text-decoration: line-through;
        color: #777;
        background-color: #222;
      }
      .role-display,
      .admin-panel-ui {
        padding: 10px;
        background-color: #1e1e1e;
        border: 1px solid #444;
        border-radius: 5px;
        text-align: center;
        margin-bottom: 15px;
      }
      .phase-display {
        font-size: 1.5em;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        text-transform: capitalize;
        color: #bb86fc;
      }
      .timer-display {
        font-size: 1.2em;
        text-align: center;
        color: #fdd835;
        margin-bottom: 20px;
      }
      .action-area {
        min-height: 100px;
        border: 1px dashed #555;
        padding: 15px;
        border-radius: 5px;
        background-color: #1e1e1e;
      }
      .action-area h4 {
        margin-top: 0;
      }
      .action-area select,
      .action-area button {
        font-size: 1em;
        margin: 10px 5px 0 0;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #444;
        background-color: #2c2c2c;
        color: #e0e0e0;
      }
      .action-area button,
      .admin-panel-ui button {
        background-color: #3f51b5;
        border: none;
        cursor: pointer;
      }
      .action-area button:hover:not(:disabled),
      .admin-panel-ui button:hover {
        background-color: #5c6bc0;
      }
      .action-area button:disabled {
        background-color: #333;
        color: #777;
        cursor: not-allowed;
      }
      .vote-btn-yes {
        background-color: #4caf50 !important;
      }
      .vote-btn-yes:hover {
        background-color: #66bb6a !important;
      }
      .vote-btn-no {
        background-color: #f44336 !important;
      }
      .vote-btn-no:hover {
        background-color: #ef5350 !important;
      }
      hr {
        border-color: #444;
        margin: 20px 0;
      }
      .log-panel {
        height: 200px;
        overflow-y: scroll;
        border: 1px solid #333;
        padding: 10px;
        background: #1e1e1e;
        margin-top: 20px;
        display: flex;
        flex-direction: column-reverse;
      }
      .log-panel div {
        padding-bottom: 5px;
        margin-bottom: 5px;
        border-bottom: 1px solid #333;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  </head>
  <body>
    <div class="game-container">
      <div class="main-panel">
        <div id="phase-display" class="phase-display">Loading...</div>
        <div id="timer-display" class="timer-display"></div>
        <div id="action-area" class="action-area">
          <p>Please wait for the game to begin.</p>
        </div>
        <h3>Game Log</h3>
        <div id="log-panel" class="log-panel"></div>
      </div>
      <div class="side-panel">
        <div
          id="admin-panel-ui"
          class="admin-panel-ui"
          style="display: none"
        ></div>
        <div id="role-display" class="role-display">
          Your Role: <strong id="my-role">Unknown</strong>
        </div>
        <h3>Players</h3>
        <ul id="player-list" class="player-list"></ul>
      </div>
    </div>

    <script>
      const socket = io();
      let myRole = "{{ player_role or 'unknown' }}";
      let myPlayerId = "{{ player_id }}";
      let livingPlayers = [],
        allPlayers = [],
        isAdmin = false,
        timerInterval;

      const phaseDisplay = document.getElementById("phase-display");
      const timerDisplay = document.getElementById("timer-display");
      const actionArea = document.getElementById("action-area");
      const logPanel = document.getElementById("log-panel");
      const playerListEl = document.getElementById("player-list");
      const myRoleDisplay = document.getElementById("my-role");
      const adminPanelUI = document.getElementById("admin-panel-ui");

      function logMessage(message) {
        const div = document.createElement("div");
        div.innerHTML = message;
        logPanel.prepend(div);
      }
      function updatePlayerListView() {
        playerListEl.innerHTML = "";
        const livingIds = livingPlayers.map((p) => p.id);
        allPlayers.forEach((p) => {
          const li = document.createElement("li");
          li.id = `player-li-${p.id}`;
          li.textContent = p.username;
          if (p.id === myPlayerId) li.textContent += " (You)";
          if (!livingIds.includes(p.id)) {
            li.classList.add("dead");
            li.textContent += " ðŸ’€";
          }
          playerListEl.appendChild(li);
        });
      }

      function populateSelect(elementId, players, includeNobody = false) {
        const select = document.getElementById(elementId);
        if (!select) return;
        select.innerHTML = "";
        if (includeNobody) {
          const option = document.createElement("option");
          option.value = ""; // Empty value for "Nobody"
          option.textContent = "--- Accuse Nobody ---";
          select.appendChild(option);
        }
        players.forEach((p) => {
          const option = document.createElement("option");
          option.value = p.id;
          option.textContent = p.username;
          select.appendChild(option);
        });
      }

      function renderActionUI(phase) {
        actionArea.innerHTML = "";
        adminPanelUI.innerHTML = "";
        adminPanelUI.style.display = "none";
        const amIAlive = livingPlayers.some((p) => p.id === myPlayerId);

        if (isAdmin && amIAlive && phase === "day_discussion") {
          adminPanelUI.style.display = "block";
          adminPanelUI.innerHTML = `<h4>Admin Action</h4><button id="initiate-lynch-btn">Start Lynch Vote</button>`;
          document.getElementById("initiate-lynch-btn").onclick = () => {
            if (confirm("End discussion and start the lynch vote?"))
              socket.emit("admin_initiate_lynch");
          };
        }

        if (!amIAlive) {
          actionArea.innerHTML =
            "<h3>You are dead.</h3><p>You can observe the rest of the game.</p>";
          return;
        }

        if (phase === "night") {
          if (myRole === "wolf") {
            actionArea.innerHTML = `<h4>Wolves, who will you eat?</h4><select id="action-select"></select> <button id="action-btn">Submit</button><div id="wolf-pack-choices" style="margin-top: 10px;"></div>`;
            populateSelect("action-select", livingPlayers);
            document.getElementById("action-btn").onclick = () => {
              socket.emit("wolf_choice", {
                target_id: document.getElementById("action-select").value,
              });
              actionArea.innerHTML = `<p>Vote cast. Waiting for other wolves...</p><div id="wolf-pack-choices" style="margin-top: 10px;"></div>`;
            };
          } else if (myRole === "seer") {
            actionArea.innerHTML = `<h4>Seer, whose role will you see?</h4><select id="action-select"></select> <button id="action-btn">Investigate</button>`;
            populateSelect("action-select", livingPlayers);
            document.getElementById("action-btn").onclick = () => {
              socket.emit("seer_choice", {
                target_id: document.getElementById("action-select").value,
              });
              actionArea.innerHTML = `<p>Waiting for your vision...</p>`;
            };
          } else {
            actionArea.innerHTML =
              "<p>You are sleeping. Wait for the morning.</p>";
          }
        } else if (phase === "day_discussion") {
          actionArea.innerHTML = `<h4>Who is the wolf?</h4><p>You may make one accusation.</p><select id="accuse-select"></select><button id="accuse-btn">Accuse</button><hr><h4>Ready for Night?</h4><p>A majority vote ends the day immediately.</p><button id="vote-end-day-btn">Vote to Start Night</button><div id="end-day-vote-counter" style="margin-top: 10px;"></div>`;
          populateSelect("accuse-select", livingPlayers, true); // Include "Nobody" option
          document.getElementById("accuse-btn").onclick = () =>
            socket.emit("accuse_player", {
              target_id: document.getElementById("accuse-select").value,
            });
          document.getElementById("vote-end-day-btn").onclick = () => {
            socket.emit("vote_to_end_day");
            document.getElementById("vote-end-day-btn").disabled = true;
            document.getElementById("vote-end-day-btn").textContent = "Voted";
          };
        } else if (phase === "day_voting") {
          actionArea.innerHTML = `<p>The village is voting. Please wait...</p>`;
        }
      }

      socket.on("connect", () => socket.emit("client_ready_for_game_state"));
      socket.on("your_role", (data) => {
        myRole = data.role;
        isAdmin = data.is_admin;
        myRoleDisplay.textContent =
          myRole.charAt(0).toUpperCase() + myRole.slice(1);
        if (isAdmin) myRoleDisplay.innerHTML += " ðŸ‘‘";
      });
      socket.on("phase_change", (data) => {
        if (data.all_players) allPlayers = data.all_players;
        livingPlayers = data.living_players;
        phaseDisplay.textContent = data.phase.replace(/_/g, " ");
        logMessage(
          `A new phase has begun: <strong>${data.phase.replace(/_/g, " ")}</strong>.`,
        );
        updatePlayerListView();
        renderActionUI(data.phase);

        // Timer logic
        if (timerInterval) clearInterval(timerInterval);
        timerDisplay.textContent = "";
        if (data.duration > 0) {
          let timeLeft = data.duration;
          timerDisplay.textContent = `Time left: ${Math.floor(timeLeft / 60)}:${("0" + (timeLeft % 60)).slice(-2)}`;
          timerInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft >= 0) {
              timerDisplay.textContent = `Time left: ${Math.floor(timeLeft / 60)}:${("0" + (timeLeft % 60)).slice(-2)}`;
            } else {
              clearInterval(timerInterval);
              timerDisplay.textContent = "Time's up!";
            }
          }, 1000);
        }
      });
      socket.on("reconnect_state", (data) => {
        myRole = data.role;
        isAdmin = data.is_admin;
        myRoleDisplay.textContent =
          myRole.charAt(0).toUpperCase() + myRole.slice(1);
        if (isAdmin) myRoleDisplay.innerHTML += " ðŸ‘‘";
        socket.emit("client_ready_for_game_state");
      });
      socket.on("seer_result", (data) => {
        const msg = `Your vision reveals that <strong>${data.username}</strong> is a <strong>${data.role}</strong>.`;
        logMessage(msg);
        actionArea.innerHTML = `<p>${msg} Keep this secret!</p>`;
      });
      socket.on("wolf_pack_update", (data) => {
        if (myRole !== "wolf") return;
        const choicesDiv = document.getElementById("wolf-pack-choices");
        if (!choicesDiv) return;
        choicesDiv.innerHTML = "<h4>Pack Votes:</h4>";
        for (const [wolfId, targetId] of Object.entries(data)) {
          const wolfName =
            allPlayers.find((p) => p.id === wolfId)?.username || "A wolf";
          const targetName =
            allPlayers.find((p) => p.id === targetId)?.username || "someone";
          choicesDiv.innerHTML += `<p>${wolfName} voted for ${targetName}</p>`;
        }
      });
      socket.on("night_result_kill", (data) => {
        const { username, role, id } = data.killed_player;
        logMessage(
          `A body was found! <strong>${username}</strong> was killed. They were a <strong>${role}</strong>.`,
        );
        livingPlayers = livingPlayers.filter((p) => p.id !== id);
        updatePlayerListView();
      });
      socket.on("night_result_no_kill", () =>
        logMessage(
          "The sun rises, and to everyone's surprise, no one was killed.",
        ),
      );
      socket.on("error", (data) => alert("An error occurred: " + data.message));
      socket.on("accusation_made", (data) => {
        logMessage(
          `<strong>${data.accuser_name}</strong> accuses <strong>${data.accused_name}</strong>!`,
        );
        if (data.accuser_id === myPlayerId) {
          const accuseBtn = document.getElementById("accuse-btn");
          if (accuseBtn) {
            accuseBtn.disabled = true;
            accuseBtn.textContent = "You Have Accused";
          }
        }
      });
      socket.on("end_day_vote_update", (data) => {
        const counter = document.getElementById("end-day-vote-counter");
        if (counter)
          counter.innerHTML = `Votes to end day: <strong>${data.count} / ${data.total}</strong>`;
      });
      socket.on("lynch_vote_started", (data) => {
        logMessage(
          `<strong>${data.target_name}</strong> has been put on trial!`,
        );
        const amIAlive = livingPlayers.some((p) => p.id === myPlayerId);
        if (amIAlive) {
          actionArea.innerHTML = `<h4>Will you lynch ${data.target_name}?</h4><button id="vote-yes-btn" class="vote-btn-yes">Yes</button> <button id="vote-no-btn" class="vote-btn-no">No</button>`;
          document.getElementById("vote-yes-btn").onclick = () => {
            socket.emit("cast_lynch_vote", { vote: "yes" });
            actionArea.innerHTML = `<p>You voted <strong>YES</strong>. Waiting...</p>`;
          };
          document.getElementById("vote-no-btn").onclick = () => {
            socket.emit("cast_lynch_vote", { vote: "no" });
            actionArea.innerHTML = `<p>You voted <strong>NO</strong>. Waiting...</p>`;
          };
        }
      });
      socket.on("lynch_vote_result", (data) => {
        logMessage(data.message);
        if (data.killed_id) {
          livingPlayers = livingPlayers.filter((p) => p.id !== data.killed_id);
          updatePlayerListView();
        }
        actionArea.innerHTML = `<p>The trial is over. The village has decided.</p>`;
      });
    </script>
  </body>
</html>
