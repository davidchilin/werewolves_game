<!-- Version: 2.0.0 -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Werewolves - The Game</title>
    <style>
      /* --- Base Styles --- */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        min-height: 100vh;
        background-color: #111111;
        color: #eeeecc;
      }
      .game-container {
        width: 95%;
        max-width: 800px;
        display: flex;
        gap: 20px;
      }
      .main-panel {
        flex-grow: 1;
        min-width: 0; /* Prevents flexbox overflow */
      }
      .side-panel {
        width: 250px;
        border-left: 1px solid #444;
        padding-left: 20px;
        flex-shrink: 0; /* Prevents side panel from shrinking */
        display: flex;
        flex-direction: column;
      }

      /* --- UI Components --- */
      .player-list {
        padding-left: 0;
      }
      .player-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        list-style-type: none;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 5px;
        background-color: #2c2c2c;
      }
      .player-list li.dead {
        text-decoration: line-through;
        color: #777;
        background-color: #222;
      }
      .accusation-count {
        font-size: 0.9em;
        font-weight: bold;
        background-color: #c62828;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: auto;
      }
      .role-display {
        padding: 10px;
        background-color: #1e1e1e;
        border: 1px solid #444;
        border-radius: 5px;
        text-align: center;
        margin-bottom: 15px;
      }
      .phase-display {
        font-size: 1.5em;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        text-transform: capitalize;
        color: #bb86fc;
      }
      .timer-display {
        font-size: 1.2em;
        text-align: center;
        color: #fdd835;
        margin-bottom: 20px;
      }

      /* --- Standard Action Area --- */
      .action-area {
        min-height: 100px;
        border: 1px dashed #555;
        padding: 15px;
        border-radius: 5px;
        background-color: #1e1e1e;
      }
      .action-area h4 {
        margin-top: 0;
      }
      .action-area select,
      .action-area button {
        font-size: 1.1em;
        margin: 10px 5px 0 0;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #444;
        background-color: #2c2c2c;
        color: #e0e0e0;
      }
      .action-area button {
        background-color: #3f51b5;
        border: none;
        cursor: pointer;
      }
      .action-area button:hover:not(:disabled) {
        background-color: #5c6bc0;
      }
      .action-area button:disabled {
        background-color: #333;
        color: #777;
        cursor: not-allowed;
      }
      .vote-btn-yes {
        background-color: #4caf50 !important;
      }
      .vote-btn-yes:hover {
        background-color: #66bb6a !important;
      }
      .vote-btn-no {
        background-color: #f44336 !important;
      }
      .vote-btn-no:hover {
        background-color: #ef5350 !important;
      }
      hr {
        border-color: #444;
        margin: 20px 0;
      }
      /* --- Phase 4: Pass-and-Play Styles --- */
      #game-interface {
        display: none; /* Hidden by default */
      }
      .pnp-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .pnp-btn {
        width: 100%;
        padding: 15px;
        background-color: #3f51b5;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        cursor: pointer;
        text-align: center;
        transition: transform 0.1s;
      }
      .pnp-btn:active {
        transform: scale(0.98);
      }
      .confirm-box {
        border: 2px solid #fdd835;
        padding: 20px;
        text-align: center;
        background: #222;
        border-radius: 10px;
        margin-top: 20px;
      }
      .confirm-box h3 {
        margin-top: 0;
        color: #fdd835;
      }
      .confirm-box button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 1.1em;
        cursor: pointer;
        border-radius: 5px;
        border: none;
      }
      .confirm-box button:first-of-type {
        background-color: #4caf50;
        color: white;
      }
      .confirm-box button.cancel {
        background-color: #f44336;
        color: white;
      }
      .role-header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #444;
        padding-bottom: 10px;
      }
      .target-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }
      .target-grid button {
        padding: 12px 20px;
        background-color: #444;
        border: 1px solid #666;
        color: white;
        cursor: pointer;
        border-radius: 6px;
      }
      .target-grid button:hover {
        background-color: #666;
      }

      /* --- Chat & Logs --- */
      .log-panel {
        height: 200px;
        overflow-y: scroll;
        border: 1px solid #333;
        padding: 10px;
        background: #1e1e1e;
        margin-top: 20px;
        display: flex;
        flex-direction: column-reverse;
      }
      .log-panel div {
        padding-bottom: 5px;
        margin-bottom: 5px;
        border-bottom: 1px solid #333;
      }
      .log-panel .vote-summary {
        font-size: 0.9em;
        color: #aaa;
      }
      .chat-container {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
      }
      .chat-messages {
        height: 150px;
        overflow-y: auto;
        border: 1px solid #333;
        padding: 10px;
        background: #1e1e1e;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column-reverse;
      }
      .chat-form {
        display: flex;
      }
      .chat-input {
        flex-grow: 1;
        margin-right: 10px;
      }
      .ghost-chat {
        color: #a0a0ff;
        font-style: italic;
      }
      .announcement {
        color: #bb86fc;
        font-weight: bold;
      }

      /* --- Game Over Overlay --- */
      #game-over-screen {
        display: none; /* Keep it hidden by default */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(18, 18, 18, 0.95);
        z-index: 100;
        overflow-y: auto; /* Allow scrolling on small screens */
      }
      .game-over-box {
        width: 90%;
        max-width: 500px;
        padding: 20px;
        margin: 20px 0;
        background-color: #1e1e1e;
        border: 1px solid #bb86fc; /* Purple highlight border */
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
      #game-over-title {
        color: #bb86fc; /* Purple title */
        margin-top: 0;
        font-size: 2.5em;
      }
      #final-roles-list {
        list-style-type: none;
        padding: 0;
        margin-top: 20px;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
      }
      #final-roles-list li {
        background-color: #2c2c2c;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 5px;
      }
      #return-to-lobby-btn {
        margin-top: 25px;
        padding: 12px 24px;
        font-size: 1.1em;
        color: white;
        background-color: #3f51b5;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      #return-to-lobby-btn:disabled {
        background-color: #333;
        cursor: not-allowed;
      }
      #rematch-vote-status {
        margin-top: 15px;
        font-size: 0.9em;
        color: #aaa;
        min-height: 20px;
      }
      .chat-messages div {
        padding-bottom: 5px;
        margin-bottom: 5px;
        border-bottom: 1px solid #333;
      }
      #admin-controls-ingame button {
        margin-top: 10px;
        width: 100%;
      }
      .btn-active {
        background-color: #dd6655; !important;
      }

      /* --- Mobile Responsive Styles --- */
      @media (max-width: 768px) {
        body {
          align-items: flex-start; /* Align to top on mobile */
          padding-top: 15px;
        }
        .game-container {
          flex-direction: column;
          gap: 0;
        }
        .side-panel {
          width: 100%;
          border-left: none;
          border-top: 1px solid #444;
          padding-left: 0;
          padding-top: 20px;
          margin-top: 20px;
        }
      }
    </style>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <div class="game-container">
      <div class="main-panel">
        <div id="phase-display" class="phase-display">Loading...</div>
        <div id="timer-display" class="timer-display"></div>
        <div
          id="action-status-message"
          style="
            display: none;
            color: #fdd835;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            border: 1px solid #fdd835;
            padding: 10px;
            border-radius: 5px;
          "
        ></div>
        <div id="action-area" class="action-area"><p>Please wait...</p></div>

        <div id="game-interface"></div>

        <h3>Game Log</h3>
        <div id="log-panel" class="log-panel"></div>
      </div>

      <div class="side-panel" id="side-panel">
        <div id="role-display" class="role-display">
          Your Role: <strong id="my-role">Unknown</strong>
        </div>

        <div id="admin-controls-ingame" style="display: none">
          <button
            id="admin-next-phase-btn"
            style="width: 100%; margin-top: 5px"
          >
            Next Phase
          </button>
          <button
            id="admin-chat-toggle-btn"
            style="width: 100%; margin-top: 5px"
          >
            Toggle Admin Chat
          </button>
        </div>

        <h3>Players</h3>
        <ul id="player-list" class="player-list"></ul>

        <div id="game-chat-container" class="chat-container">
          <h4 id="chat-title">Living Chat</h4>
          <div id="game-chat-messages" class="chat-messages"></div>
          <form id="game-chat-form" class="chat-form" action="#">
            <input
              id="game-chat-input"
              class="chat-input"
              type="text"
              placeholder="Type a message..."
              autocomplete="off"
            />
            <button id="game-chat-send-btn" type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>

    <!-- This container is hidden by default. JavaScript will show it when 'game_over' event triggered. It holds the final results. -->
    <div id="game-over-screen">
      <div class="game-over-box">
        <h1 id="game-over-title"></h1>
        <h2 id="game-over-reason"></h2>
        <h3>Final Roles:</h3>
        <ul id="final-roles-list"></ul>
        <button id="return-to-lobby-btn">Vote to Return to Lobby</button>
        <div id="rematch-vote-status"></div>

        <div id="game-over-chat-container" class="chat-container">
          <h4>Post-Game Chat</h4>
          <div id="game-over-chat-messages" class="chat-messages"></div>
          <form id="game-over-chat-form" class="chat-form" action="#">
            <input
              id="game-over-chat-input"
              class="chat-input"
              type="text"
              placeholder="Type a message..."
              autocomplete="off"
            />
            <button id="game-over-chat-send-btn" type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      // Global State
      let myRole,
        myPlayerId = "{{ player_id }}",
        isAlive = false;
      let livingPlayers = [],
        allPlayers = [],
        isAdmin = false;
      let timerInterval,
        timersDisabled = false;

      // Phase 4 State
      let isPassAndPlay = false;
      let hasActed = new Set(),
        myNightTargetId = null,
        myAccusationId = null,
        myLynchVote = null,
        currentLynchTargetName = "Unkown",
        mySleepVote = false;

      // --- DOM Elements ---
      const phaseDisplay = document.getElementById("phase-display");
      const timerDisplay = document.getElementById("timer-display");
      const actionArea = document.getElementById("action-area");
      const gameInterface = document.getElementById("game-interface"); // PnP container
      const logPanel = document.getElementById("log-panel");
      const playerListEl = document.getElementById("player-list");
      const myRoleDisplay = document.getElementById("my-role");
      const sidePanel = document.getElementById("side-panel");

      // Admin
      const adminControlsIngame = document.getElementById(
        "admin-controls-ingame",
      );
      const adminChatToggleBtn = document.getElementById(
        "admin-chat-toggle-btn",
      );
      const adminNextPhaseBtn = document.getElementById("admin-next-phase-btn");

      // Game Chat
      const gameChatTitle = document.getElementById("chat-title");
      const gameChatMessages = document.getElementById("game-chat-messages");
      const gameChatForm = document.getElementById("game-chat-form");
      const gameChatInput = document.getElementById("game-chat-input");
      const gameChatSendBtn = document.getElementById("game-chat-send-btn");

      // Game Over Chat
      const gameOverScreen = document.getElementById("game-over-screen");
      const gameOverChatMessages = document.getElementById(
        "game-over-chat-messages",
      );
      const gameOverChatForm = document.getElementById("game-over-chat-form");
      const gameOverChatInput = document.getElementById("game-over-chat-input");
      const gameOverChatSendBtn = document.getElementById(
        "game-over-chat-send-btn",
      );

      // --- Functions ---
      function logMessage(message) {
        let div = document.createElement("div");
        div.innerHTML = message;
        logPanel.prepend(div);
      }

      function updateAdminControls() {
        if (isAdmin) {
          adminControlsIngame.style.display = "block";
          adminNextPhaseBtn.style.display = "block";
        } else {
          adminControlsIngame.style.display = "none";
        }
      }

      function setChatMode(isAdminOnly, phase) {
        let isChatDisabled = isAdminOnly && !isAdmin;
        let placeholder = "Chat is restricted.";

        if (phase === "night" && !isAdmin) {
          placeholder = "sleepy quiet time...zzz";
          isChatDisabled = true;
        } else if (!isChatDisabled) {
          if (!isAlive) {
            gameChatTitle.textContent = "Ghost Chat ðŸ‘»";
            placeholder = "Whisper to the other side...";
          } else {
            gameChatTitle.textContent = "Living Chat";
            placeholder = "Type a message...";
          }
        }

        gameChatSendBtn.disabled = isChatDisabled;
        gameChatInput.placeholder = placeholder;
        gameOverChatSendBtn.disabled = isChatDisabled;
        gameOverChatInput.placeholder = placeholder;

        adminChatToggleBtn.classList.toggle("btn-active", isAdminOnly);
      }
      function requestGameSync() {
        // Asks server for current state (refreshes Hub in PnP)
        socket.emit("client_ready_for_game");
      }

      // --- PHASE 4: Pass-and-Play Logic ---
      function renderHub(allPlayers) {
        gameInterface.innerHTML =
          `<h2>Night Phase: Who are you?</h2><div class="pnp-grid">` +
          allPlayers
            .map((p) => {
              if (!p.is_alive) return "";
              // Check local history 'hasActed' to gray out buttons
              const disabled = hasActed.has(p.id)
                ? 'disabled style="opacity:0.5"'
                : "";
              const label = hasActed.has(p.id)
                ? `${p.username} (Done)`
                : p.username;
              return `<button class="pnp-btn" ${disabled} onclick="startConfirmFlow('${p.id}', '${p.username}')">${label}</button>`;
            })
            .join("") +
          `</div>`;
      }

      // 2. Confirmation Flow
      function startConfirmFlow(pid, name) {
        gameInterface.innerHTML = `
              <div class="confirm-box">
                  <h3>Are you ${name}?</h3>
                  <button onclick="confirmLevel2('${pid}', '${name}')">Yes, I am ${name}</button>
                  <button class="cancel" onclick="requestGameSync()">No, go back</button>
              </div>`;
      }

      function confirmLevel2(pid, name) {
        // Level 2 Confirm (Double Check)
        gameInterface.innerHTML = `
              <div class="confirm-box" style="border-color: #f44336">
                  <h3 style="color:#f44336">CONFIRM IDENTITY</h3>
                  <p>Pass device to <strong>${name}</strong>.</p>
                  <p>You are about to see secret info.</p>
                  <button onclick="loadPrivateData('${pid}')">I am ready</button>
                  <button class="cancel" onclick="requestGameSync()">Cancel</button>
              </div>`;
      }

      // 3. Load Data & Render Action
      function loadPrivateData(pid) {
        socket.emit("pnp_request_state", { player_id: pid });
      }

      // Response from server with role data
      socket.on("pnp_state_received", (data) => {
        // Render Role & Prompt (Silly or Serious)
        let roleName = data.role_name.replace("role_", "").toUpperCase();
        let html = `
              <div class="role-header">
                  <h2>You are: ${roleName}</h2>
                  <p style="font-size:1.2em; color:#fdd835">${data.prompt}</p>
              </div>
              <div class="target-grid">`;

        // Render targets (including self if returned by backend)
        html += data.targets
          .map(
            (t) =>
              `<button onclick="submitPnPAction('${data.id}', '${t.id}')">${t.name}</button>`,
          )
          .join("");

        // Add "Skip/No Action" button if applicable?
        html += `</div>`;
        gameInterface.innerHTML = html;
      });

      // 4. Submit & Return
      function submitPnPAction(actorId, targetId) {
        socket.emit("pnp_submit_action", {
          actor_id: actorId,
          target_id: targetId,
        });
        hasActed.add(actorId); // Mark local

        gameInterface.innerHTML = `<div class="confirm-box"><h3>Action Recorded.</h3><p>Please pass the device.</p></div>`;
        setTimeout(() => requestGameSync(), 2000);
      }

      // --- Standard UI Logic ---

      function submitLynchVote(vote) {
        // 1. Send vote to server
        socket.emit("cast_lynch_vote", { vote: vote });

        // 2. Update local state immediately
        myLynchVote = vote;

        // 3. Re-render UI to show the "You voted" message
        renderActionUI("lynch_vote_phase");
      }

      function populateSelect(elementId, players, includeNobody = false) {
        const select = document.getElementById(elementId);
        if (!select) return;
        select.innerHTML = "";
        if (includeNobody) {
          let optionText = "Nobody";
          select.innerHTML += `<option value="">${optionText}</option>`;
        }

        // shuffle player dropdown for less bias
        const shuffledPlayers = [...players];
        shuffledPlayers.sort(() => 0.5 - Math.random());

        shuffledPlayers.forEach((p) => {
          select.innerHTML += `<option value="${p.id}">${p.username}</option>`;
        });
      }

      function renderActionUI(phase) {
        actionArea.innerHTML = "";

        // DEAD VIEW
        if (!isAlive) {
          actionArea.innerHTML =
            "<h3>You are dead ðŸ’€ You can observe the game in silence.</h3>";
          return;
        }

        // STANDARD NIGHT VIEW
        if (phase === "night") {
          if (myRole === "wolf") {
            if (myNightTargetId === null) {
              actionArea.innerHTML = `<h4>Wolf, who will you eat?</h4><select id="action-select"></select> <button id="action-btn">Kill</button>`;
              populateSelect("action-select", livingPlayers, true);
              document.getElementById("action-btn").onclick = () => {
                socket.emit("wolf_choice", {
                  target_id: document.getElementById("action-select").value,
                });
                const playerPicked =
                  "Nobody" ||
                  actionSelect[actionSelect.options.selectedIndex].text;
                actionArea.innerHTML = `<p>You are hungry for <span style="color: #ff0000">${playerPicked}</span>. Waiting ...</p>`;
              };
            } else {
              const target = allPlayers.find((p) => p.id === myNightTargetId);
              const targetName = target ? target.username : "Nobody";
              actionArea.innerHTML = `<p>You are hungry for <span style="color:
                #ff0000">${targetName}</span>. Waiting ...</p>`;
              return;
            }
          } else if (myRole === "seer") {
            if (myNightTargetId === null) {
              actionArea.innerHTML = `<h4>Seer, whose role will you see?</h4><select id="action-select"></select> <button id="action-btn">Investigate</button>`;
              populateSelect("action-select", livingPlayers, true);
              document.getElementById("action-btn").onclick = () => {
                socket.emit("seer_choice", {
                  target_id: document.getElementById("action-select").value,
                });
                actionArea.innerHTML = `<p>You have seen all that you can see tonight.</p>`;
              };
            } else {
              actionArea.innerHTML = `<p>You have seen all that you can see tonight.</p>`;
              return;
            }
          } else {
            if (myNightTargetId === null) {
              actionArea.innerHTML = `<p>You are dreaming of yummy pupusas while the night creatures are stirring ...  </p><h4>Who is acting quirky this night?</h4><select
                    id="action-select"></select> <button id="action-btn">Select</button>`;
              populateSelect("action-select", livingPlayers, true);
              document.getElementById("action-btn").onclick = () => {
                actionArea.innerHTML = `<p>You have made your choice.</p>`;
              };
            } else {
              actionArea.innerHTML = `<p>You have made your choice.</p>`;
              return;
            }
          }
        } else if (phase === "accusation_phase") {
          let accusationHTML = "";
          // Check if already accused (considering "Nobody" as a valid accusation)
          if (myAccusationId !== null) {
            const target = allPlayers.find((p) => p.id === myAccusationId);
            const targetName = target ? target.username : "Nobody";
            accusationHTML = `<h3>You have accused <span style="color:#ff5252">${targetName}</span>.</h3><p>Waiting for others...</p>`;
          } else {
            accusationHTML = `
                  <h4>Who is the wolf? Time for discussion!</h4>
                  <select id="accuse-select"></select>
                  <button id="accuse-btn">Accuse</button>`;
            //                  <hr><h4>Ready for Night?</h4><button id="vote-end-day-btn" disabled>ðŸ’¤ Vote to Sleep (30s)</button><div id="end-day-vote-counter" style="margin-left:10px"></div>`;
          }
          // Check if already voted to sleep
          let sleepBtnState = "";
          let sleepBtnText = "ðŸ’¤ Vote to Sleep (30s)";

          if (mySleepVote) {
            sleepBtnState = "disabled";
            sleepBtnText = "Voted to Sleep ðŸ’¤";
          } else {
            // If not voted, button starts disabled and enables after timeout
            sleepBtnState = "disabled"; // Initially disabled
          }

          // Combine Sections
          actionArea.innerHTML = `
             <div id="accusation-section">${accusationHTML}</div>
             <hr style="border-color: #444; margin: 15px 0;">
             <div id="sleep-section">
                <h4>Ready for Night?</h4>
                <button id="vote-end-day-btn" ${sleepBtnState}>${sleepBtnText}</button>
                <span id="end-day-vote-counter" style="margin-left:10px; font-size:0.9em; color:#aaa"></span>
             </div>
          `;

          // --- SECTION C: Event Listeners ---

          // 1. Accusation Logic (Only if dropdown exists)
          if (myAccusationId === null) {
            populateSelect("accuse-select", livingPlayers, true);
            document.getElementById("accuse-btn").onclick = () => {
              const select = document.getElementById("accuse-select");
              if (select)
                socket.emit("accuse_player", { target_id: select.value });
            };
          }
          // 2. Sleep Button Logic
          // Only attach logic if we haven't voted yet
          if (!mySleepVote) {
            const voteBtn = document.getElementById("vote-end-day-btn");

            // Enable button after 30 seconds
            setTimeout(() => {
              if (voteBtn) {
                voteBtn.disabled = false;
                voteBtn.textContent = "Vote to Sleep";
              }
            }, 30000); // 30,000 milliseconds = 30 seconds

            voteBtn.onclick = function () {
              socket.emit("vote_to_end_day");
              // Local Immediate Update
              this.disabled = true;
              this.textContent = "Voted to Sleep ðŸ’¤";
              mySleepVote = true; // Prevent re-enabling
            };
          }
        } else if (phase === "lynch_vote_phase") {
          const voted = myLynchVote === "yes" || myLynchVote === "no";
          if (voted) {
            const voteText = myLynchVote === "yes" ? "YES" : "NO";
            const color = myLynchVote === "yes" ? "red" : "green";
            actionArea.innerHTML = `<h3>You voted: <span style="color:${color}">${voteText}</span></h3><p>Waiting for result...</p>`;
            return;
          }

          // If not voted, SHOW BUTTONS (Moved from lynch_vote_started)
          actionArea.innerHTML = `
             <h4>Will you lynch <span style="color:#bb86fc">${currentLynchTargetName}</span>?</h4>
             <button id="vote-yes-btn" onclick="submitLynchVote('yes')" class="vote-btn-yes">YES</button>
             <button id="vote-no-btn" onclick="submitLynchVote('no')" class="vote-btn-no">NO</button>
           `;
        }
      }

      function startTimer(duration) {
        if (timerInterval) clearInterval(timerInterval);
        timerDisplay.textContent = "";
        if (timersDisabled) {
          timerDisplay.textContent = "Timer â™¾ï¸";
          return;
        }
        if (duration > 0) {
          let timeLeft = duration;
          const update = () => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = Math.floor(timeLeft % 60);
            timerDisplay.textContent = `Time left: ${minutes}:${(
              "0" + seconds
            ).slice(-2)}`;
          };
          update();
          timerInterval = setInterval(() => {
            if (--timeLeft >= 0) update();
            else {
              clearInterval(timerInterval);
              timerDisplay.textContent = "Time's up!";
            }
          }, 1000);
        }
      }

      function showGameOverScreen(data) {
        if (timerInterval) clearInterval(timerInterval);

        document.querySelector(".game-container").style.display = "none";
        gameOverScreen.style.display = "flex";
        // Populate game over data...
        document.getElementById(
          "game-over-title",
        ).textContent = `The ${data.winning_team} Win!`;
        document.getElementById("game-over-reason").textContent = data.reason;

        const rolesList = document.getElementById("final-roles-list");
        rolesList.innerHTML = "";
        data.final_player_states.forEach((p) => {
          rolesList.innerHTML += `<li><strong>${p.name}</strong> was a ${
            p.role
          } ${p.is_alive ? "" : "ðŸ’€"}</li>`;
        });

        document.getElementById("return-to-lobby-btn").onclick = (event) => {
          socket.emit("vote_for_rematch");
          event.target.disabled = true;
          event.target.textContent = "Voted!";
        };
      }

      // --- Socket Events ---

      socket.on("connect", () => {
        console.log("[DEBUG] Client connected to /game page.");
        socket.emit("client_ready_for_game");
      });

      // Unified State Update
      socket.on("game_state_sync", (data) => {
        myRole = data.your_role;
        isAdmin = data.is_admin;
        isAlive = data.is_alive;
        livingPlayers = data.living_players;
        allPlayers = data.all_players;
        timersDisabled = data.timers_disabled;
        myNightTargetId = data.my_night_target_id;
        myAccusationId = data.my_accusation_id;
        mySleepVote = data.my_sleep_vote;
        myLynchVote = data.my_lynch_vote;
        currentLynchTargetName = data.lynch_target_name || "Unknown";

        // Determine Mode
        isPassAndPlay = data.mode === "pass_and_play";

        // Handle Game Over
        if (
          (data.phase === "ended" || data.phase === "game_over") &&
          data.game_over_data
        ) {
          showGameOverScreen(data.game_over_data);
          setChatMode(data.admin_only_chat, data.phase);
          return;
        }

        // PHASE 4 Logic: Toggle Interfaces
        if (isPassAndPlay && data.phase === "night") {
          // Hide Chat, Hide Standard Action
          sidePanel.style.display = "none"; // Hide chat & player list
          actionArea.style.display = "none";
          gameInterface.style.display = "block";
          phaseDisplay.textContent = "Night (Pass Device)";
          renderHub(allPlayers);
        } else {
          // Standard Mode / Day Phase
          sidePanel.style.display = "flex"; // Show chat
          actionArea.style.display = "block";
          gameInterface.style.display = "none";

          myRoleDisplay.textContent =
            (myRole || "Unknown") + (isAdmin ? " ðŸ‘‘" : "");
          if (data.phase)
            phaseDisplay.textContent = data.phase.replace(/_/g, " ");

          renderActionUI(data.phase);

          adminChatToggleBtn.style.display = "block";
          // Clear local PnP history if phase changed to Day
          if (data.phase !== "night") hasActed.clear();
        }

        phaseDisplay.textContent = data.phase.replace(/_/g, " ");
        renderActionUI(data.phase);

        updatePlayerListView(data.accusation_counts || {});
        updateAdminControls();
        setChatMode(data.admin_only_chat, data.phase);
        startTimer(data.duration);
        adminChatToggleBtn.classList.toggle("btn-active", data.admin_only_chat);
      });

      // Also listen for simple phase change updates
      socket.on("phase_change", (data) => {
        logMessage(
          `A new phase has begun: <strong>${data.phase.replace(
            /_/g,
            " ",
          )}</strong>.`,
        );

        livingPlayers = data.living_players;
        if (data.all_players) allPlayers = data.all_players;
        timersDisabled = data.timers_disabled;
        phaseDisplay.textContent = data.phase.replace(/_/g, " ");
        renderActionUI(data.phase);
        updatePlayerListView();
        updateAdminControls();
        setChatMode(data.admin_only_chat, data.phase);
        startTimer(data.duration);
        adminChatToggleBtn.classList.toggle("btn-active", data.admin_only_chat);
        socket.emit("client_ready_for_game"); // Trigger full sync to handle UI logic
      });

      // Messages
      socket.on("message", (data) => logMessage(data.text));
      socket.on("new_message", (data) => {
        const messageEl = document.createElement("div");
        messageEl.innerHTML = data.text;

        if (data.channel === "announcement") {
          messageEl.classList.add("announcement");
          gameChatMessages.prepend(messageEl.cloneNode(true));
          gameOverChatMessages.prepend(messageEl.cloneNode(true));
          return;
        }

        if (data.channel === "lobby") {
          gameOverChatMessages.prepend(messageEl);
          return;
        }

        if (isAlive && data.channel === "living") {
          gameChatMessages.prepend(messageEl);
        } else if (!isAlive && data.channel === "ghost") {
          messageEl.classList.add("ghost-chat");
          gameChatMessages.prepend(messageEl);
        }
      });

      // Actions

      socket.on("chat_mode_update", (data) => {
        setChatMode(data.admin_only_chat, data.phase);
        adminChatToggleBtn.classList.toggle("btn-active", data.admin_only_chat);
      });

      socket.on("night_result_kill", (data) => {
        const { username, role, id } = data.killed_player;
        logMessage(
          `ðŸ«€ Remnants of a body were found! <strong>${username}</strong> was killed. They were a <strong>${role}</strong> âš°ï¸`,
        );
        if (myPlayerId === id) {
          isAlive = false;
          setChatMode(data.admin_only_chat, data.phase);
        }
      });

      socket.on("seer_result", (data) => {
        const msg = `Your vision reveals that <strong>${data.username}</strong> is <strong>${data.role}</strong>.`;
        logMessage(msg);
        actionArea.innerHTML = `<p>${msg}</p>`;
      });

      socket.on("night_result_no_kill", () =>
        logMessage("ðŸŒž The sun rises, and no one was killed."),
      );

      socket.on("wolf_team_info", (data) => {
        if (data.teammates.length > 0) {
          logMessage(
            `You are a wolf. Your fellow wolves are: <strong>${data.teammates.join(
              ", ",
            )}</strong>.`,
          );
        } else {
          logMessage(`You are the lone wolf.`);
        }
      });

      socket.on("lynch_vote_result", (data) => {
        let fullMessage = data.message;
        if (data.summary) {
          fullMessage += `<div class="vote-summary">Voted Yes: ${
            data.summary.yes.join(", ") || "None"
          }<br>Voted No: ${data.summary.no.join(", ") || "None"}</div>`;
        }
        logMessage(fullMessage);
        if (data.killed_id && data.killed_id === myPlayerId) {
          isAlive = false;
          setChatMode(data.admin_only_chat, data.phase);
        }
      });

      socket.on("error", (data) => {
        alert("Error: " + data.message);
      });

      socket.on("force_phase_update", () =>
        socket.emit("client_ready_for_game"),
      );

      // Admin & Utils
      function updatePlayerListView(accusationCounts = {}) {
        playerListEl.innerHTML = "";
        const livingIds = livingPlayers.map((p) => p.id);
        allPlayers.forEach((p) => {
          const li = document.createElement("li");
          const nameSpan = document.createElement("span");
          nameSpan.textContent =
            p.username + (p.id === myPlayerId ? " (You)" : "");
          li.appendChild(nameSpan);
          const count = accusationCounts[p.id] || 0;
          if (count > 0) {
            const countBadge = document.createElement("span");
            countBadge.className = "accusation-count";
            countBadge.textContent = count;
            li.appendChild(countBadge);
          }
          if (!livingIds.includes(p.id)) {
            li.classList.add("dead");
            nameSpan.textContent += " ðŸ’€";
          }
          playerListEl.appendChild(li);
        });
      }

      socket.on("accusation_made", (data) => {
        logMessage(
          `<strong>${data.accuser_name}</strong> accuses <strong>${data.accused_name}</strong>!`,
        );
        if (
          myPlayerId &&
          allPlayers.find((p) => p.id === myPlayerId)?.username ===
            data.accuser_name
        ) {
          const accuseBtn = document.getElementById("accuse-btn");
          if (accuseBtn) {
            accuseBtn.disabled = true;
            accuseBtn.textContent = "Accused";
          }
        }
      });

      socket.on("accusation_update", (data) => updatePlayerListView(data));
      socket.on("end_day_vote_update", (data) => {
        const counter = document.getElementById("end-day-vote-counter");
        if (counter)
          counter.innerHTML = `<strong>${
            1 + Math.floor(data.total / 2) - data.count
          }</strong> more votes needed to sleep!`;
      });

      socket.on("lynch_vote_started", (data) => {
        logMessage(`<strong>${data.target_name}</strong> is on trial!`);

        // Update Local State
        currentLynchTargetName = data.target_name;
        phaseDisplay.textContent = "Lynch Vote";

        renderActionUI("lynch_vote_phase");

        startTimer(data.duration);
      });

      // listener waits for 'game_over' message from server.
      // Then hides main game area and displays results screen,
      // populating it with the winner, reason, and list of roles from the server.
      socket.on("game_over", (data) => {
        showGameOverScreen(data);
      });

      // listens for updates on the rematch vote count and
      // displays the status to the players.
      socket.on("rematch_vote_update", (data) => {
        const statusEl = document.getElementById("rematch-vote-status");
        if (statusEl) {
          statusEl.textContent = `${data.count} / ${data.total} players have voted to return.`;
        }
      });

      // listens for final signal from server, sent
      // upon vote passes, then performs lobby redirect.
      socket.on("redirect_to_lobby", () => {
        logMessage("Majority vote reached! Returning to lobby...");
        window.location.href = "/lobby";
      });

      socket.on("force_relogin", (data) => {
        alert(
          `Admin has set a new game code.\nYou will now be returned to the login screen.`,
        );
        window.location.href = "/";
      });

      // --- Event Listeners ---
      adminChatToggleBtn.addEventListener("click", () => {
        socket.emit("admin_toggle_chat");
        adminChatToggleBtn.classList.toggle("btn-active", data.admin_only_chat);
      });

      adminNextPhaseBtn.addEventListener("click", () => {
        socket.emit("admin_next_phase");
        adminChatToggleBtn.classList.toggle("btn-active", data.admin_only_chat);
      });

      gameChatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (gameChatInput.value.trim())
          socket.emit("send_message", { message: gameChatInput.value });
        gameChatInput.value = "";
      });

      gameOverChatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = gameOverChatInput.value.trim();
        if (message) {
          socket.emit("send_message", { message: message });
          gameOverChatInput.value = "";
        }
      });
    </script>
  </body>
</html>
